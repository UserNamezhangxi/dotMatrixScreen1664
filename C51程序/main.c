#include<reg51.h>
#include <intrins.h>

#define uchar unsigned char
#define uint unsigned int

sbit si=P2^0;  //数据线  74hc595的14管脚
sbit rck=P2^1;  //输出储存器锁存时钟线 74hc595的12管脚
sbit sck=P2^2;  //数据输入时钟线  74hc595的11管脚
sbit fmq=P3^5;
sbit DQ=P2^4;
uchar data disdata[15];
uint tvalue;                       //温度值
uchar tflag;                       //温度正负标志

uchar code taba[16]={0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,};//列扫描显示编码
uchar code tt1[][32]={

{0xFF,0x7F,0xFE,0xFF,0x80,0x03,0xFB,0xBB,0xFB,0xBB,0xC0,0x03,0xFB,0xBB,0xFB,0xBB,
0xF8,0x3B,0xFF,0xFB,0xF0,0x0B,0xF7,0xDB,0xFB,0xBD,0xFC,0x7D,0xF3,0x9E,0x8F,0xE3},/*"度",0*/
/* (16 X 16 , 宋体 )*/

{0xFF,0xFF,0xE0,0x3B,0xEF,0xB7,0xEF,0xB7,0xE0,0x3E,0xEF,0xBD,0xEF,0xBD,0xE0,0x37,
0xFF,0xF7,0xC0,0x1B,0xDA,0xD8,0xDA,0xDB,0xDA,0xDB,0xDA,0xDB,0x80,0x0B,0xFF,0xFF},/*"温",1*/
/* (16 X 16 , 宋体 )*/
};

uchar code maohao[]={
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF3,0xFF,0xF3,
0xFF,0xFF,0xFF,0xFF,0xFF,0xF3,0xFF,0xF3,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,/*"未命名文件",0*/
};

uchar code fuhao[] = {
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF3,0xFF,0xF3,
0xC1,0xFF,0xFF,0xFF,0xFF,0xF3,0xFF,0xF3,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,/*"未命名文件",0*/
};

uchar code numtab[][16]={
{0xFF,0xFF,0xFF,0xE7,0xDB,0xBD,0xBD,0xBD,0xBD,0xBD,0xBD,0xBD,0xDB,0xE7,0xFF,0xFF},/*"0",0*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xF7,0xF1,0xF7,0xF7,0xF7,0xF7,0xF7,0xF7,0xF7,0xF7,0xC1,0xFF,0xFF},/*"1",1*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xC3,0xBD,0xBD,0xBD,0xDF,0xDF,0xEF,0xF7,0xFB,0xBD,0x81,0xFF,0xFF},/*"2",2*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xC3,0xBD,0xBD,0xDF,0xE7,0xDF,0xBF,0xBF,0xBD,0xDD,0xE3,0xFF,0xFF},/*"3",3*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xDF,0xCF,0xD7,0xDB,0xDB,0xDD,0xDD,0x81,0xDF,0xDF,0x87,0xFF,0xFF},/*"4",4*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0x81,0xFD,0xFD,0xFD,0xE5,0xD9,0xBF,0xBF,0xBD,0xDD,0xE3,0xFF,0xFF},/*"5",5*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xC7,0xDB,0xFD,0xFD,0xE5,0xD9,0xBD,0xBD,0xBD,0xDB,0xE7,0xFF,0xFF},/*"6",6*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0x81,0xDD,0xDD,0xEF,0xEF,0xF7,0xF7,0xF7,0xF7,0xF7,0xF7,0xFF,0xFF},/*"7",7*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xC3,0xBD,0xBD,0xBD,0xDB,0xE7,0xDB,0xBD,0xBD,0xBD,0xC3,0xFF,0xFF},/*"8",8*/
/* (8 X 16 , 宋体 )*/

{0xFF,0xFF,0xFF,0xE7,0xDB,0xBD,0xBD,0xBD,0x9B,0xA7,0xBF,0xBF,0xDB,0xE3,0xFF,0xFF},/*"9",9*/
/* (8 X 16 , 宋体 )*/
 };


void delay(unsigned int p)
{  
    unsigned char i;  
    while(p--)  
    {   
    	for(i=110;i>0;i--);  
    }   
}   
void sendHC595Byte(uchar pp)
{     
    uchar i;   
    for(i=0;i<8;i++)  
    {   
		sck=0;   
        if(pp&0x80)
		{
		    si=1;   
		}
        else 
		{
			si=0;
		}   
       	sck=1;   
        pp<<=1;   
    }
}   

void sendHC154(uint i) 
{
	P1 = i;
}

  
/******************************ds18b20程序***************************************/
void delay_18B20(unsigned int i)//延时
{
   i= i*2;
   while(i--);
}

void ds1820rst()                //ds1820复位
{ 
    DQ = 1;                     //DQ复位
    delay_18B20(4);             //延时
    DQ = 0;                     //DQ拉低
    delay_18B20(100);           //精确延时大于480us
    DQ = 1;                     //拉高
    delay_18B20(40); 
} 

uchar ds1820rd()                //读数据
{ 
   unsigned char i=0;
   unsigned char dat = 0;
   for (i=8;i>0;i--)
   {  
    DQ = 0;                   //给脉冲信号
    dat>>=1;
    DQ = 1;                   //给脉冲信号
    if(DQ)
    dat|=0x80;
    delay_18B20(10);
   }
   return(dat);
}


void ds1820wr(uchar wdata)  /*写数据*/
{
    unsigned char i=0;
    for (i=8;i>0;i--)
    { DQ=0;
      DQ=wdata&0x01;
      delay_18B20(10);
      DQ=1;
      wdata>>=1;
    }
}


read_temp()               //读取温度值并转换
{
   uchar a,b;
   ds1820rst();    
   ds1820wr(0xcc);        //跳过读序列号
   ds1820wr(0x44);        //启动温度转换
   ds1820rst();    
   ds1820wr(0xcc);        //跳过读序列号
   ds1820wr(0xbe);        //读取温度
   a=ds1820rd();
   b=ds1820rd();
   tvalue=b;
   tvalue<<=8;
   tvalue=tvalue|a;
	if(tvalue<0x0fff)     //判断温度的正负值
	tflag=0;
	else
	{
	 tvalue=~tvalue+1;
	 tflag=1;
	}
   tvalue=tvalue*(0.625);  //DS18B20的精确度为0.0625度, 即读回数据的最低位代表0.0625度
                           //将它放大10倍, 使显示时可显示小数点后一位, 并对小数点后第二2进行4舍5入(也就是说tvalue中有n个0.0625)
   return(tvalue);
}


/*********************温度值显示部分**********************************/
void ds1820disp()                    //温度值显示函数
{   
    // uchar flagdat,t;
	 //uint alarm;
     //disdata[0]=tvalue/1000+0x30;       //百位数,其中0的ASCII代码为
     disdata[1]=tvalue%1000/100+0x30;  //十位数
     disdata[2]=tvalue%100/10+0x30;     //个位数
   //  disdata[3]=tvalue%10+0x30;         //小数位
    
//     if(tflag==0)
//     flagdat=' ';                    //正温度不显示符号
//     else
//     flagdat='-';                  //负温度显示负号:-  

}

void main()
{
    uchar i=0;
	uint valueshi,valuege;
    uint k;
	uchar tempNum[32];
    while(1)
    {
	  read_temp();
	  ds1820disp();
	  valueshi = disdata[1];
	  valuege = disdata[2];
	  for(i=0;i<16;i++)
	  {
		tempNum[i*2+0] = numtab[valuege][i];
		tempNum[i*2+1] = numtab[valueshi][i];
	  }
	    
	   for(k=0;k<3;k++)
		{
		   for(i=0;i<16;i++) // 行数据选择 
		    {  		
	    		//4
 				sendHC595Byte(tempNum[i*2]);	//第j个字 第一个行高位 
		        sendHC595Byte(tempNum[i*2 + 1]);	//第j个字 第一个行低位 
				
				// 3
				if(tflag==0){
					sendHC595Byte(maohao[i*2]);	//第j个字 第一个行高位 
		            sendHC595Byte(maohao[i*2 + 1]);	//第j个字 第一个行低位 
				} else {
					sendHC595Byte(fuhao[i*2]);	//第j个字 第一个行高位 
		            sendHC595Byte(fuhao[i*2 + 1]);	//第j个字 第一个行低位 	
				}

				// 2
    			sendHC595Byte(tt1[0][i*2]);	//第j个字 第一个行高位 
		        sendHC595Byte(tt1[0][i*2 + 1]);	//第j个字 第一个行低位 

				// 1
				sendHC595Byte(tt1[1][i*2]);	//第j个字 第一个行高位 
		        sendHC595Byte(tt1[1][i*2 + 1]);	//第j个字 第一个行低位 

		        sendHC154(taba[i]);
		        rck=1;
				_nop_();
		        rck=0;
	       }
		}
	}
}